#include <ESP8266WiFi.h>
#include <ESP8266WebServer.h>

// Configura√ß√µes WiFi (substitua pelas suas)
const char* ssid = "SeuSSID";       // Nome da rede WiFi
const char* password = "SuaSenha";  // Senha da rede WiFi

// Pinos para motores (ajuste conforme seu rob√¥)
// Assumindo ponte H: IN1, IN2 para motor esquerdo; IN3, IN4 para direito
#define MOTOR_ESQ_IN1 D1  // Pino para frente esquerdo
#define MOTOR_ESQ_IN2 D2  // Pino para tr√°s esquerdo
#define MOTOR_DIR_IN3 D3  // Pino para frente direito
#define MOTOR_DIR_IN4 D4  // Pino para tr√°s direito

ESP8266WebServer server(80);  // Servidor na porta 80

// Fun√ß√£o para parar motores
void pararMotores() {
  digitalWrite(MOTOR_ESQ_IN1, LOW);
  digitalWrite(MOTOR_ESQ_IN2, LOW);
  digitalWrite(MOTOR_DIR_IN3, LOW);
  digitalWrite(MOTOR_DIR_IN4, LOW);
}

// Fun√ß√£o para mover para frente
void moverFrente() {
  digitalWrite(MOTOR_ESQ_IN1, HIGH);
  digitalWrite(MOTOR_ESQ_IN2, LOW);
  digitalWrite(MOTOR_DIR_IN3, HIGH);
  digitalWrite(MOTOR_DIR_IN4, LOW);
}

// Fun√ß√£o para mover para tr√°s
void moverTras() {
  digitalWrite(MOTOR_ESQ_IN1, LOW);
  digitalWrite(MOTOR_ESQ_IN2, HIGH);
  digitalWrite(MOTOR_DIR_IN3, LOW);
  digitalWrite(MOTOR_DIR_IN4, HIGH);
}

// Fun√ß√£o para virar esquerda
void virarEsquerda() {
  digitalWrite(MOTOR_ESQ_IN1, LOW);
  digitalWrite(MOTOR_ESQ_IN2, HIGH);
  digitalWrite(MOTOR_DIR_IN3, HIGH);
  digitalWrite(MOTOR_DIR_IN4, LOW);
}

// Fun√ß√£o para virar direita
void virarDireita() {
  digitalWrite(MOTOR_ESQ_IN1, HIGH);
  digitalWrite(MOTOR_ESQ_IN2, LOW);
  digitalWrite(MOTOR_DIR_IN3, LOW);
  digitalWrite(MOTOR_DIR_IN4, HIGH);
}

// Handler para servir o HTML na raiz
void handleRoot() {
  String html = R"rawliteral(
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <!-- Metatag viewport otimizada para mobile, impedindo zoom e scroll acidental -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Rob√¥ Wireless - Controle Moderno</title>
    <style>
        /* Reset e vari√°veis CSS para tema moderno */
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --accent: #00d4ff;
            --accent-hover: #00a8cc;
            --text: #ffffff;
            --shadow: rgba(0, 212, 255, 0.3);
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: var(--bg-primary);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow: hidden;
        }

        /* Preven√ß√£o de sele√ß√£o e toque */
        .prevent-select {
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* Cabe√ßalho com gradiente e glow */
        header {
            text-align: center;
            margin-bottom: 40px;
        }

        h1, h2 {
            font-weight: 300;
            text-shadow: 0 0 20px var(--shadow);
            margin: 10px 0;
        }

        h1 {
            font-size: 2.5rem;
            background: linear-gradient(45deg, var(--accent), #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        h2 {
            font-size: 1.5rem;
            opacity: 0.8;
        }

        /* Controle principal: Layout em cruz (D-pad) usando Flexbox */
        .control-layout {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin: 20px auto;
        }

        .row {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        /* Centro do controle */
        .center {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(145deg, var(--accent), var(--accent-hover));
            box-shadow: 0 0 30px var(--shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { box-shadow: 0 0 30px var(--shadow); }
            to { box-shadow: 0 0 50px var(--accent); }
        }

        /* Bot√µes direcionais */
        .btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(145deg, #333, #555);
            border: 2px solid var(--accent);
            color: var(--text);
            font-size: 1.5rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .btn:hover {
            background: linear-gradient(145deg, #444, #666);
            transform: scale(1.05);
        }

        .btn:active {
            background: linear-gradient(145deg, var(--accent), var(--accent-hover));
            /* Removido o recuo: sem scale down ou translateY */
        }

        /* √çcones SVG para bot√µes */
        .btn svg {
            width: 30px;
            height: 30px;
            fill: var(--text);
        }

        /* Status de conex√£o */
        .status {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Footer */
        footer {
            margin-top: 40px;
            font-size: 0.9rem;
            opacity: 0.7;
            text-align: center;
        }

        /* Responsividade */
        @media (max-width: 600px) {
            .btn {
                width: 60px;
                height: 60px;
                font-size: 1.2rem;
            }
            .btn svg {
                width: 25px;
                height: 25px;
            }
            .center {
                width: 80px;
                height: 80px;
                font-size: 1.5rem;
            }
            h1 { font-size: 2rem; }
            h2 { font-size: 1.2rem; }
        }
    </style>
</head>
<body unselectable="on" class="prevent-select">
    <header>
        <h1> ROB√ìTICA DR JO√ÇO DA ROCHA CHUEIRI</h1>
        <h2>üëæ Rob√¥ gerson üëæ</h2>
    </header>

    <div class="control-layout">
        <!-- Linha superior: bot√£o cima -->
        <div class="row">
            <button class="btn prevent-select" id="botao1" aria-label="Mover para cima">
                <svg viewBox="0 0 24 24"><path d="M7 14l5-5 5 5z"/></svg>
            </button>
        </div>
        <!-- Linha do meio: esquerda, centro, direita -->
        <div class="row">
            <button class="btn prevent-select" id="botao2" aria-label="Mover para esquerda">
                <svg viewBox="0 0 24 24"><path d="M14 7l-5 5 5 5z"/></svg>
            </button>
            <div class="center prevent-select">üéØ</div>
            <button class="btn prevent-select" id="botao3" aria-label="Mover para direita">
                <svg viewBox="0 0 24 24"><path d="M10 7l5 5-5 5z"/></svg>
            </button>
        </div>
        <!-- Linha inferior: bot√£o baixo -->
        <div class="row">
            <button class="btn prevent-select" id="botao4" aria-label="Mover para baixo">
                <svg viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
            </button>
        </div>
    </div>

    <footer>
        <p>Projeto desenvolvido pelo aluno LUIZ GABRIELü§≠</p>
    </footer>

    <script>
        const botao1 = document.getElementById('botao1');
        const botao2 = document.getElementById('botao2');
        const botao3 = document.getElementById('botao3');
        const botao4 = document.getElementById('botao4');

        let intervalID = null;
        let botaoAtivo = null; // Controle do bot√£o ativo

        function iniciarAcao(botao, comando) {
            if (botaoAtivo === null) {
                botaoAtivo = botao;
                // Feedback visual adicional (opcional: vibra√ß√£o simulada)
                if (navigator.vibrate) navigator.vibrate(50);
                intervalID = setInterval(() => {
                    fetch('/pressionado', { method: 'POST', body: comando });
                }, 100);
            }
        }

        function pararAcao(botao) {
            if (botaoAtivo === botao) {
                clearInterval(intervalID);
                fetch('/pressionado', { method: 'POST', body: '0' });
                botaoAtivo = null;
            }
        }

        // Eventos para toque e mouse
        [botao1, botao2, botao3, botao4].forEach((botao, index) => {
            const comando = (index + 1).toString();
            botao.addEventListener('touchstart', (e) => { e.preventDefault(); iniciarAcao(botao, comando); });
            botao.addEventListener('touchend', () => pararAcao(botao));
            botao.addEventListener('mousedown', () => iniciarAcao(botao, comando));
            botao.addEventListener('mouseup', () => pararAcao(botao));
            botao.addEventListener('mouseleave', () => pararAcao(botao)); // Para mouse sair
        });
    </script>
</body>
</html>
)rawliteral";
  server.send(200, "text/html", html);
}

// Handler para receber comandos POST
void handlePressionado() {
  if (server.method() == HTTP_POST) {
    String comando = server.arg("plain");  // Recebe o body do POST
    Serial.println("Comando recebido: " + comando);

    if (comando == "1") {
      moverFrente();
    } else if (comando == "2") {
      virarEsquerda();
    } else if (comando == "3") {
      virarDireita();
    } else if (comando == "4") {
      moverTras();
    } else if (comando == "0") {
      pararMotores();
    }

    server.send(200, "text/plain", "OK");
  } else {
    server.send(405, "text/plain", "Method Not Allowed");
  }
}

void setup() {
  Serial.begin(115200);

  // Configurar pinos dos motores como sa√≠da
  pinMode(MOTOR_ESQ_IN1, OUTPUT);
  pinMode(MOTOR_ESQ_IN2, OUTPUT);
  pinMode(MOTOR_DIR_IN3, OUTPUT);
  pinMode(MOTOR_DIR_IN4, OUTPUT);
  pararMotores();  // Iniciar parado

  // Conectar ao WiFi
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(1000);
    Serial.println("Conectando ao WiFi...");
  }
  Serial.println("Conectado! IP: " + WiFi.localIP().toString());

  // Configurar rotas do servidor
  server.on("/", handleRoot);
  server.on("/pressionado", handlePressionado);

  server.begin();
  Serial.println("Servidor iniciado");
}

void loop() {
  server.handleClient();  // Processar requisi√ß√µes
}
